/**
 * Scale Calibration Utility
 *
 * Use this to find the correct calibration factor for your load cell.
 *
 * Instructions:
 * 1. Rename this file to main.cpp (backup original main.cpp)
 * 2. Flash to ESP32-S3
 * 3. Open serial monitor at 115200 baud
 * 4. Follow on-screen instructions
 * 5. Note down your calibration factor
 * 6. Update CALIBRATION_FACTOR in main.cpp
 */

#include <Arduino.h>
#include "HX711.h"

#define HX711_DT_PIN   1
#define HX711_SCK_PIN  2

HX711 scale;
float calibrationFactor = 420.0;  // Starting point

// Known calibration weight in grams
const float KNOWN_WEIGHT = 100.0;  // Use a 100g calibration weight

void setup() {
    Serial.begin(115200);
    delay(1000);

    Serial.println("\n========================================");
    Serial.println("HX711 Scale Calibration Utility");
    Serial.println("========================================\n");

    scale.begin(HX711_DT_PIN, HX711_SCK_PIN);

    if (!scale.is_ready()) {
        Serial.println("ERROR: HX711 not found!");
        Serial.println("Check wiring and restart.");
        while (1) delay(1000);
    }

    Serial.println("HX711 found!");
    Serial.println("\nStep 1: Remove all weight from scale");
    Serial.println("Press ENTER in serial monitor when ready...");

    while (!Serial.available()) delay(100);
    while (Serial.available()) Serial.read();

    Serial.println("Taring scale...");
    scale.set_scale();
    scale.tare();
    Serial.println("Tare complete.\n");

    Serial.printf("Step 2: Place %.0fg weight on scale\n", KNOWN_WEIGHT);
    Serial.println("Press ENTER when ready...");

    while (!Serial.available()) delay(100);
    while (Serial.available()) Serial.read();

    Serial.println("\nCalibrating...");
    Serial.println("Adjust factor with +/- keys, 'q' to quit\n");
}

void loop() {
    scale.set_scale(calibrationFactor);

    float weight = scale.get_units(10);  // Average of 10 readings

    Serial.printf("Factor: %.2f | Reading: %.2f g | Target: %.0f g",
                  calibrationFactor, weight, KNOWN_WEIGHT);

    float error = weight - KNOWN_WEIGHT;
    if (abs(error) < 0.5) {
        Serial.print(" [CALIBRATED!]");
    }
    Serial.println();

    // Check for serial input
    if (Serial.available()) {
        char c = Serial.read();

        switch (c) {
            case '+':
                calibrationFactor += 10;
                break;
            case '-':
                calibrationFactor -= 10;
                break;
            case '*':
                calibrationFactor += 1;
                break;
            case '/':
                calibrationFactor -= 1;
                break;
            case 'q':
            case 'Q':
                Serial.println("\n========================================");
                Serial.printf("FINAL CALIBRATION FACTOR: %.2f\n", calibrationFactor);
                Serial.println("========================================");
                Serial.println("\nUpdate this value in main.cpp:");
                Serial.printf("float calibrationFactor = %.2f;\n", calibrationFactor);
                Serial.println("\nCalibration complete. Restart to test.");
                while (1) delay(1000);
                break;
        }
    }

    delay(200);
}

/*
 * Serial Commands:
 *   +  Increase factor by 10
 *   -  Decrease factor by 10
 *   *  Increase factor by 1 (fine tune)
 *   /  Decrease factor by 1 (fine tune)
 *   q  Quit and show final factor
 */
